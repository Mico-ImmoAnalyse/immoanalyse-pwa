<script>

function toggleHelp() {
  document.getElementById('helpPanel').classList.toggle('open');
  document.getElementById('overlay').classList.toggle('open');
}

/* ===========================
   CALCULS
   =========================== */

function calculLtvNet(ltv, cov, type, liq) {
  const liqEffective = Math.min(10, liq + 2);
  const pondSurete = (type === 'fid') ? 1.2 : 1.0;

  let ltvNet = ltv - (cov / 100 * pondSurete * (liqEffective / 10) * 100);

  return Math.max(0, Math.round(ltvNet));
}

function calculScoreRisque(ltv, lta, ltc, marge, precom, liq, type) {
  let score = 0;

  if (ltv <= 60) score += 5;
  else if (ltv <= 75) score += 15;
  else if (ltv <= 85) score += 30;
  else score += 45;

  if (!isNaN(lta) && lta > 0) {
    if (lta <= 90) score += 5;
    else if (lta <= 100) score += 15;
    else score += 30;
  }

  if (!isNaN(ltc) && ltc > 0) {
    if (ltc <= 85) score += 5;
    else if (ltc <= 90) score += 15;
    else score += 30;
  }

  if (marge >= 20) score += 5;
  else if (marge >= 15) score += 15;
  else if (marge >= 10) score += 25;
  else score += 40;

  if (precom >= 80) score += 5;
  else if (precom >= 50) score += 15;
  else if (precom >= 25) score += 25;
  else score += 35;

  if (liq >= 8) score += 5;
  else if (liq >= 6) score += 15;
  else score += 30;

  if (type === 'fid') score -= 10;

  return Math.max(0, Math.min(100, Math.round(score)));
}

function calculSuggestionIA(ltv, lta, ltc, marge, precom, liq, type, scoreRisque) {
  let suggest = 1000;

  if (scoreRisque >= 80) suggest = 150;
  else if (scoreRisque >= 65) suggest = 250;
  else if (scoreRisque >= 50) suggest = 400;
  else if (scoreRisque >= 35) suggest = 600;
  else suggest = 800;

  if (ltv > 90) suggest = Math.min(suggest, 100);
  else if (ltv > 80) suggest = Math.min(suggest, 250);

  if (!isNaN(lta) && lta > 100) suggest = Math.min(suggest, 250);
  if (!isNaN(ltc) && ltc > 90) suggest = Math.min(suggest, 250);

  if (marge < 8) suggest = Math.min(suggest, 150);
  else if (marge < 12) suggest = Math.min(suggest, 250);

  if (precom < 25) suggest = Math.min(suggest, 300);

  if (type === 'fid' && scoreRisque <= 50) {
    suggest = Math.min(1000, suggest + 150);
  }

  return Math.max(100, Math.min(1000, Math.round(suggest)));
}

function calculStatut(scoreRisque, ltv, marge, precom) {
  if (ltv > 100) return "üö® CRITIQUE";
  if (marge < 5) return "üö® CRITIQUE";

  if (scoreRisque <= 30 && marge >= 20 && precom >= 50) return "üíé PREMIUM";
  if (scoreRisque <= 50) return "‚úÖ SAFE";
  if (scoreRisque <= 70) return "‚ö†Ô∏è TENDU";

  return "üö® CRITIQUE";
}

/* ===========================
   AJOUT / RENDU
   =========================== */

function ajouterProjet() {
  const nom = document.getElementById('nom').value || "Projet Master";
  const ltv = parseFloat(document.getElementById('ltv').value) || 0;
  const marge = parseFloat(document.getElementById('marge').value) || 0;
  const precom = parseFloat(document.getElementById('precom').value) || 0;
  const liq = parseInt(document.getElementById('liq').value) || 5;
  const type = document.getElementById('typeSurete').value;
  const cov = parseFloat(document.getElementById('cov').value) || 100;
  const lta = parseFloat(document.getElementById('lta').value) || 0;
  const ltc = parseFloat(document.getElementById('ltc').value) || 0;
  const realInvest = parseFloat(document.getElementById('realInvest').value) || 0;

  const ltvNet = calculLtvNet(ltv, cov, type, liq);
  const scoreRisque = calculScoreRisque(ltv, lta, ltc, marge, precom, liq, type);
  const suggest = calculSuggestionIA(ltv, lta, ltc, marge, precom, liq, type, scoreRisque);
  const status = calculStatut(scoreRisque, ltv, marge, precom);

  const p = {
    date: new Date().toLocaleDateString('fr-FR'),
    nom,
    ltv,
    marge,
    precom,
    liq,
    type,
    cov,
    lta,
    ltc,
    ltvNet,
    scoreRisque,
    status,
    investSuggest: suggest,
    investReal: realInvest
  };

  let db = JSON.parse(localStorage.getItem('immo_v34')) || [];
  db.push(p);
  localStorage.setItem('immo_v34', JSON.stringify(db));

  render();
  document.getElementById('realInvest').value = '';
}

function render() {
  const db = JSON.parse(localStorage.getItem('immo_v34')) || [];
  const body = document.getElementById('bodyTable');

  body.innerHTML = "";

  let sScore = 0, sTotal = 0;

  [...db].reverse().forEach((p, idx) => {
    sScore += p.scoreRisque || 0;
    sTotal += p.investReal || 0;

    let badgeClass =
      p.status.includes('üíé') ? 'badge-premium' :
      p.status.includes('‚úÖ') ? 'badge-safe' :
      p.status.includes('‚ö†Ô∏è') ? 'badge-tendu' :
      'badge-critique';

    body.innerHTML += `
<tr>
  <td>
    <b>${p.nom}</b><br>
    <small style="color:var(--text-soft);">
      ${p.date} ‚Ä¢ Pr√©: ${p.precom}% ‚Ä¢ LTA: ${p.lta || '-'}% ‚Ä¢ LTC: ${p.ltc || '-'}%
    </small>
  </td>

  <td style="font-weight:bold;">
    ${p.ltvNet}%<br>
    <small style="color:var(--text-soft);">LTV brut: ${p.ltv}%</small>
  </td>

  <td>
    <span class="badge ${badgeClass}">${p.status}</span><br>
    <small style="color:var(--text-soft);">
      Marge: ${p.marge}% ‚Ä¢ Score: ${p.scoreRisque}/100
    </small>
  </td>

  <td>
    <small style="color:var(--text-soft);">IA: ${p.investSuggest}‚Ç¨</small><br>
    <b style="color:var(--blue)">R√âEL: ${p.investReal}‚Ç¨</b>
  </td>

  <td>
    <button onclick="suppr(${db.length - 1 - idx})"
      style="border:none; background:none; cursor:pointer; color:var(--text-soft);">
      ‚úñ
    </button>
  </td>
</tr>`;
  });

  if (db.length > 0) {
    const avgScore = Math.round(sScore / db.length);
    document.getElementById('avgRisk').innerText = avgScore + "/100";
    document.getElementById('totalInvest').innerText = sTotal + " ‚Ç¨";

    const label = document.getElementById('riskLabel');

    if (avgScore <= 30) { label.innerText = "S√âCURIS√â üõ°Ô∏è"; label.style.color = "var(--emerald)"; }
    else if (avgScore <= 50) { label.innerText = "√âQUILIBR√â ‚öñÔ∏è"; label.style.color = "var(--blue)"; }
    else if (avgScore <= 70) { label.innerText = "VIGILANCE ‚ö†Ô∏è"; label.style.color = "var(--amber)"; }
    else { label.innerText = "CRITIQUE üö®"; label.style.color = "var(--rose)"; }

  } else {
    document.getElementById('avgRisk').innerText = "0/100";
    document.getElementById('totalInvest').innerText = "0 ‚Ç¨";

    const label = document.getElementById('riskLabel');
    label.innerText = "Aucun projet";
    label.style.color = "var(--text-soft)";
  }
}

function suppr(idx) {
  let db = JSON.parse(localStorage.getItem('immo_v34')) || [];
  db.splice(idx, 1);
  localStorage.setItem('immo_v34', JSON.stringify(db));
  render();
}

function exportCSV() {
  const db = JSON.parse(localStorage.getItem('immo_v34')) || [];
  if (db.length === 0) return alert("Aucune donn√©e.");

  let csv = "Date;Nom;LTV;Marge;Precom;Liq;Surete;Couv;LTA;LTC;LTVNet;Score;Status;IA;Reel\n";

  db.forEach(p => {
    csv += `${p.date};${p.nom};${p.ltv};${p.marge};${p.precom};${p.liq};${p.type};${p.cov};${p.lta || ""};${p.ltc || ""};${p.ltvNet};${p.scoreRisque};${p.status};${p.investSuggest};${p.investReal}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.setAttribute("download", `Audit_Master_v34.csv`);
  link.click();
}

/* ===========================
   TH√àME CLAIR / SOMBRE
   =========================== */

function toggleTheme() {
  const isLight = document.body.classList.toggle("light");
  localStorage.setItem("theme", isLight ? "light" : "dark");

  const btn = document.getElementById("themeBtn");
  btn.textContent = isLight ? "Mode sombre" : "Mode clair";
}

document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById("themeBtn");

  if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light");
    btn.textContent = "Mode sombre";
  } else {
    btn.textContent = "Mode clair";
  }

  render();
});

</script>

</body>
</html>
