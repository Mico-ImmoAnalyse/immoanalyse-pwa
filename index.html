<!DOCTYPE html>
<html lang="fr">

<head>
<meta charset="UTF-8">
<title>ImmoAnalyse v3.4.1</title>
<link rel="manifest" href="manifest.webmanifest">

<style>
/* ===========================
VARIABLES MODE SOMBRE
=========================== */
:root {
  --bg: #050816;
  --card: #0b1020;
  --card-soft: #11172a;
  --text-main: #e5e7eb;
  --text-soft: #9ca3af;
  --border-soft: #1f2937;
  --emerald: #22c55e;
  --blue: #3b82f6;
  --amber: #f59e0b;
  --rose: #fb7185;
  --gold: #facc15;
}

/* ===========================
RESET
=========================== */
* { box-sizing: border-box; }

body {
  margin: 0;
  background: var(--bg);
  color: var(--text-main);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
  transition: background 0.3s ease, color 0.3s ease;
}

/* ===========================
LAYOUT
=========================== */
h1 { font-size: 1.4rem; margin: 18px 0 10px; }

.dashboard {
  max-width: 1200px;
  margin: 24px auto;
  padding: 0 16px 40px;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}

.top-bar-right {
  display: flex;
  gap: 8px;
  align-items: center;
}

/* ===========================
BOUTONS
=========================== */
.btn {
  border-radius: 999px;
  border: 1px solid var(--border-soft);
  background: var(--card);
  color: var(--text-main);
  padding: 6px 12px;
  font-size: 0.8rem;
  cursor: pointer;
}

.btn-ghost { background: transparent; }

.btn-gold {
  background: linear-gradient(135deg, var(--gold), color-mix(in srgb, var(--gold) 70%, #ffffff));
  border: none;
  color: var(--bg);
  font-weight: 600;
  box-shadow: 0 10px 30px color-mix(in srgb, var(--gold) 40%, transparent);
}

/* ===========================
SUMMARY CARDS
=========================== */
.summary-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 16px;
  margin: 18px 0 20px;
}

.summary-card {
  background: var(--card);
  border-radius: 14px;
  padding: 14px 16px;
  border: 1px solid var(--border-soft);
  box-shadow: 0 18px 45px rgba(0, 0, 0, 0.15);
}

.summary-label {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: .08em;
  color: var(--text-soft);
  margin-bottom: 6px;
}

.summary-value {
  font-size: 1.4rem;
  font-weight: 600;
}

.summary-tag {
  font-size: 0.75rem;
  color: var(--text-soft);
  margin-top: 4px;
}

/* ===========================
FORM CARD
=========================== */
.card {
  background: var(--card);
  border-radius: 16px;
  border: 1px solid var(--border-soft);
  padding: 16px 16px 18px;
  box-shadow: 0 24px 60px rgba(0, 0, 0, 0.25);
  margin-top: 10px;
}

.card h2 {
  font-size: 0.95rem;
  margin: 0 0 10px;
}

.form-body {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 10px 14px;
  align-items: flex-end;
}

label {
  display: block;
  font-size: 0.75rem;
  color: var(--text-soft);
  margin-bottom: 3px;
}

input, select {
  width: 100%;
  padding: 6px 8px;
  border-radius: 8px;
  border: 1px solid var(--border-soft);
  background: var(--card-soft);
  color: var(--text-main);
  font-size: 0.8rem;
}

input:focus, select:focus {
  outline: 1px solid var(--blue);
  border-color: var(--blue);
}

/* ===========================
TABLEAU
=========================== */
.table-wrapper {
  background: var(--card);
  border-radius: 16px;
  border: 1px solid var(--border-soft);
  overflow: hidden;
  box-shadow: 0 24px 60px rgba(0, 0, 0, 0.15);
  margin-top: 18px;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.82rem;
}

thead { background: var(--card-soft); }

th, td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border-soft);
  vertical-align: top;
  color: var(--text-main);
}

th {
  text-align: left;
  font-weight: 500;
  color: var(--text-soft);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: .08em;
}

tr:hover td { background: var(--card-soft); }

/* ===========================
BADGES
=========================== */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 0.7rem;
  font-weight: 500;
}

.badge-premium {
  background: color-mix(in srgb, var(--emerald) 15%, transparent);
  color: var(--emerald);
  border: 1px solid color-mix(in srgb, var(--emerald) 40%, transparent);
}

.badge-safe {
  background: color-mix(in srgb, var(--blue) 15%, transparent);
  color: var(--blue);
  border: 1px solid color-mix(in srgb, var(--blue) 40%, transparent);
}

.badge-tendu {
  background: color-mix(in srgb, var(--amber) 15%, transparent);
  color: var(--amber);
  border: 1px solid color-mix(in srgb, var(--amber) 40%, transparent);
}

.badge-critique {
  background: color-mix(in srgb, var(--rose) 15%, transparent);
  color: var(--rose);
  border: 1px solid color-mix(in srgb, var(--rose) 40%, transparent);
}

/* ===========================
HELP PANEL
=========================== */
.help-panel {
  position: fixed;
  top: 0;
  right: -420px;
  width: 400px;
  height: 100vh;
  background: var(--card);
  border-left: 1px solid var(--border-soft);
  padding: 20px 18px 24px;
  overflow-y: auto;
  transition: right .25s ease-out;
  z-index: 40;
}

.help-panel.open { right: 0; }

.help-panel h2 { font-size: 1rem; margin-bottom: 8px; }
.help-panel h3 { font-size: 0.9rem; margin-top: 16px; margin-bottom: 6px; }

.help-panel p, .help-panel li {
  font-size: 0.8rem;
  color: var(--text-soft);
}

/* ===========================
OVERLAY
=========================== */
#overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.35);
  backdrop-filter: blur(4px);
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s ease-out;
  z-index: 30;
}

#overlay.open {
  opacity: 1;
  pointer-events: auto;
}

/* ===========================
MODE CLAIR
=========================== */
body.light {
  --bg: #f3f4f6;
  --card: #ffffff;
  --card-soft: #f1f5f9;
  --text-main: #1f2937;
  --text-soft: #6b7280;
  --border-soft: #d1d5db;
  --emerald: #16a34a;
  --blue: #2563eb;
  --amber: #d97706;
  --rose: #dc2626;
  --gold: #ca8a04;
}

/* ===========================
FOND RADIAL SOMBRE
=========================== */
body:not(.light) {
  background: radial-gradient(circle at 30% 0%, #0f172a 0%, #0a1120 40%, #050816 100%);
}
</style>
</head>

<body>

<div class="dashboard">

<div class="top-bar">
  <div>
    <h1>ImmoAnalyse v3.4.1</h1>
    <div style="font-size:0.8rem; color:var(--text-soft);">
      Moteur IA v3.4.0 ‚Äì LTV / LTA / LTC / Marge / Pr√©com / Liquidit√© / Garantie
    </div>
  </div>

  <div class="top-bar-right">
    <button class="btn btn-ghost" onclick="toggleHelp()">Guide v3.4.0</button>
    <button class="btn" onclick="exportCSV()">Export CSV</button>
    <button id="themeBtn" class="btn" onclick="toggleTheme()">Mode clair</button>
  </div>
</div>

<div class="summary-grid">
  <div class="summary-card">
    <div class="summary-label">Score moyen du portefeuille</div>
    <div class="summary-value" id="avgRisk">0/100</div>
    <div class="summary-tag" id="riskLabel">Aucun projet</div>
  </div>

  <div class="summary-card">
    <div class="summary-label">Total investi</div>
    <div class="summary-value" id="totalInvest">0 ‚Ç¨</div>
    <div class="summary-tag">Capital engag√© sur les dossiers audit√©s</div>
  </div>

  <div class="summary-card">
    <div class="summary-label">Moteur IA</div>
    <div class="summary-tag">
      Scoring automatique, statuts PREMIUM / SAFE / TENDU / CRITIQUE, bridage des tickets selon le risque.
    </div>
  </div>
</div>

<div class="card">
<h2>Nouvel audit</h2>

<div class="form-body">

<div style="grid-column: span 2;">
  <label>Projet</label>
  <input type="text" id="nom" placeholder="Nom du dossier">
</div>

<div>
  <label>LTV (%)</label>
  <input type="number" id="ltv" value="70">
</div>

<div>
  <label>Marge (%)</label>
  <input type="number" id="marge" value="15">
</div>

<div>
  <label>Pr√©-Comm (%)</label>
  <input type="number" id="precom" value="0">
</div>

<div>
  <label>Liq. (1-10)</label>
  <input type="number" id="liq" value="7">
</div>

<div>
  <label>S√ªret√©</label>
  <select id="typeSurete">
    <option value="fid">Fiducie-S√ªret√©</option>
    <option value="hypo">Hypoth√®que 1er R.</option>
  </select>
</div>

<div>
  <label>Couv. (%)</label>
  <input type="number" id="cov" value="100">
</div>

<div>
  <label>LTA (%)</label>
  <input type="number" id="lta" placeholder="Ex: 95">
</div>

<div>
  <label>LTC (%)</label>
  <input type="number" id="ltc" placeholder="Ex: 88">
</div>

<div>
  <label>Mise (‚Ç¨)</label>
  <input type="number" id="realInvest" placeholder="Ex: 500">
</div>

<div style="grid-column: span 4; text-align:right; margin-top:4px;">
  <button class="btn btn-gold" onclick="ajouterProjet()">AUDITER & SAUVEGARDER</button>
</div>

</div>
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
  <th>Projet</th>
  <th>LTV net</th>
  <th>Risque</th>
  <th>Tickets</th>
  <th></th>
</tr>
</thead>
<tbody id="bodyTable"></tbody>
</table>
</div>

</div> <!-- dashboard -->

<div id="overlay" class="overlay" onclick="toggleHelp()"></div>

<div id="helpPanel" class="help-panel">
    <h2>Guide d‚Äôanalyse v3.4.0</h2>

    <p><b>Ce moteur IA analyse automatiquement un projet immobilier</b> en combinant :</p>
    <ul>
        <li>LTV (Loan-to-Value)</li>
        <li>LTA (Loan-to-Asset)</li>
        <li>LTC (Loan-to-Cost)</li>
        <li>Marge op√©rationnelle</li>
        <li>Pr√©-commercialisation</li>
        <li>Liquidit√© du march√©</li>
        <li>Type de s√ªret√© (Fiducie / Hypoth√®que)</li>
    </ul>

    <h3>Comment utiliser l‚Äôoutil</h3>
    <p><b>1.</b> Remplissez les champs du formulaire.</p>
    <p><b>2.</b> Cliquez sur ‚ÄúAUDITER & SAUVEGARDER‚Äù.</p>
    <p><b>3.</b> Le moteur IA calcule :</p>
    <ul>
        <li>LTV net ajust√©</li>
        <li>Score de risque (0 √† 100)</li>
        <li>Statut : üíé Premium / ‚úÖ Safe / ‚ö†Ô∏è Tendu / üö® Critique</li>
        <li>Ticket IA recommand√© (100 √† 1000 ‚Ç¨)</li>
    </ul>

    <h3>Interpr√©tation du score</h3>
    <ul>
        <li><b>0‚Äì30 :</b> üíé Premium ‚Äî risque tr√®s faible</li>
        <li><b>31‚Äì50 :</b> ‚úÖ Safe ‚Äî risque mod√©r√©</li>
        <li><b>51‚Äì70 :</b> ‚ö†Ô∏è Tendu ‚Äî vigilance n√©cessaire</li>
        <li><b>71‚Äì100 :</b> üö® Critique ‚Äî risque √©lev√©</li>
    </ul>

    <h3>Fonctionnalit√©s suppl√©mentaires</h3>
    <ul>
        <li><b>Export CSV :</b> g√©n√®re un fichier Excel de tous vos audits</li>
        <li><b>Mode clair / sombre :</b> change le th√®me</li>
        <li><b>Suppression :</b> retire un projet du tableau</li>
    </ul>
</div>

<script type="module">

import { runLPBEngine } from './engine/engine.js';

// ===========================
// AIDE
// ===========================
function toggleHelp() {
    document.getElementById('helpPanel').classList.toggle('open');
    document.getElementById('overlay').classList.toggle('open');
}

// ===========================
// CALCULS V3.4.0
// ===========================
function calculLtvNet(ltv, cov, type, liq) {
    const liqEffective = Math.min(10, liq + 2);
    const pondSurete = (type === 'fid') ? 1.2 : 1.0;
    let ltvNet = ltv - (cov / 100 * pondSurete * (liqEffective / 10) * 100);
    return Math.max(0, Math.round(ltvNet));
}

function calculScoreRisque(ltv, lta, ltc, marge, precom, liq, type) {
    let score = 0;

    if (ltv <= 60) score += 5;
    else if (ltv <= 75) score += 15;
    else if (ltv <= 85) score += 30;
    else score += 45;

    if (!isNaN(lta) && lta > 0) {
        if (lta <= 90) score += 5;
        else if (lta <= 100) score += 15;
        else score += 30;
    }

    if (!isNaN(ltc) && ltc > 0) {
        if (ltc <= 85) score += 5;
        else if (ltc <= 90) score += 15;
        else score += 30;
    }

    if (marge >= 20) score += 5;
    else if (marge >= 15) score += 15;
    else if (marge >= 10) score += 25;
    else score += 40;

    if (precom >= 80) score += 5;
    else if (precom >= 50) score += 15;
    else if (precom >= 25) score += 25;
    else score += 35;

    if (liq >= 8) score += 5;
    else if (liq >= 6) score += 15;
    else score += 30;

    if (type === 'fid') score -= 10;

    return Math.max(0, Math.min(100, Math.round(score)));
}

function calculSuggestionIA(ltv, lta, ltc, marge, precom, liq, type, scoreRisque) {
    let suggest = 1000;

    if (scoreRisque >= 80) suggest = 150;
    else if (scoreRisque >= 65) suggest = 250;
    else if (scoreRisque >= 50) suggest = 400;
    else if (scoreRisque >= 35) suggest = 600;
    else suggest = 800;

    if (ltv > 90) suggest = Math.min(suggest, 100);
    else if (ltv > 80) suggest = Math.min(suggest, 250);

    if (!isNaN(lta) && lta > 100) suggest = Math.min(suggest, 250);
    if (!isNaN(ltc) && ltc > 90) suggest = Math.min(suggest, 250);

    if (marge < 8) suggest = Math.min(suggest, 150);
    else if (marge < 12) suggest = Math.min(suggest, 250);

    if (precom < 25) suggest = Math.min(suggest, 300);

    if (type === 'fid' && scoreRisque <= 50) {
        suggest = Math.min(1000, suggest + 150);
    }

    return Math.max(100, Math.min(1000, Math.round(suggest)));
}

function calculStatut(scoreRisque, ltv, marge, precom) {
    if (ltv > 100) return "üö® CRITIQUE";
    if (marge < 5) return "üö® CRITIQUE";
    if (scoreRisque <= 30 && marge >= 20 && precom >= 50) return "üíé PREMIUM";
    if (scoreRisque <= 50) return "‚úÖ SAFE";
    if (scoreRisque <= 70) return "‚ö†Ô∏è TENDU";
    return "üö® CRITIQUE";
}

// ===========================
// AJOUT / RENDU
// ===========================
function ajouterProjet() {
    const nom = document.getElementById('nom').value || "Projet Master";
    const ltv = parseFloat(document.getElementById('ltv').value) || 0;
    const marge = parseFloat(document.getElementById('marge').value) || 0;
    const precom = parseFloat(document.getElementById('precom').value) || 0;
    const liq = parseInt(document.getElementById('liq').value) || 5;
    const type = document.getElementById('typeSurete').value;
    const cov = parseFloat(document.getElementById('cov').value) || 100;
    const lta = parseFloat(document.getElementById('lta').value) || 0;
    const ltc = parseFloat(document.getElementById('ltc').value) || 0;
    const realInvest = parseFloat(document.getElementById('realInvest').value) || 0;

    const input = {
        type: 'MDB',
        besoin: realInvest,
        valeurs: {
            prixAchat: 100000,
            valeurActif: 100000,
            travaux: 0,
            frais: 0,
            chiffreAffaires: 0,
            precommercialisation: precom,
            dureeProjetMois: liq * 3,
            liquiditeMarche: liq * 10,
            couverture: cov,
            fondsPropres: 0,
            dette: ltv / 100 * 100000
        },
        garanties: {
            fiducie: type === 'fid',
            gpd: false,
            hyp1: type === 'hypo',
            nantissement: false,
            caution: false,
            aucune: false
        }
    };

    const resultatV6 = runLPBEngine(input);
    console.log("LPB V6 ‚Üí", resultatV6);

    const ltvNet = calculLtvNet(ltv, cov, type, liq);
    const scoreRisque = calculScoreRisque(ltv, lta, ltc, marge, precom, liq, type);
    const suggest = calculSuggestionIA(ltv, lta, ltc, marge, precom, liq, type, scoreRisque);
    const status = calculStatut(scoreRisque, ltv, marge, precom);

    const p = {
        date: new Date().toLocaleDateString('fr-FR'),
        nom,
        ltv,
        marge,
        precom,
        liq,
        type,
        cov,
        lta,
        ltc,
        ltvNet,
        scoreRisque,
        status,
        investSuggest: suggest,
        investReal: realInvest
    };

    let db = JSON.parse(localStorage.getItem('immo_v34')) || [];
    db.push(p);
    localStorage.setItem('immo_v34', JSON.stringify(db));

    render();
    document.getElementById('realInvest').value = '';
}

function render() {
    const db = JSON.parse(localStorage.getItem('immo_v34')) || [];
    const body = document.getElementById('bodyTable');
    body.innerHTML = "";

    let sScore = 0, sTotal = 0;

    [...db].reverse().forEach((p, idx) => {
        sScore += p.scoreRisque || 0;
        sTotal += p.investReal || 0;

        let badgeClass =
            p.status.includes('üíé') ? 'badge-premium' :
            p.status.includes('‚úÖ') ? 'badge-safe' :
            p.status.includes('‚ö†Ô∏è') ? 'badge-tendu' :
            'badge-critique';

        body.innerHTML += `
<tr>
<td>
<b>${p.nom}</b><br>
<small style="color:var(--text-soft);">
${p.date} ‚Ä¢ Pr√©: ${p.precom}% ‚Ä¢ LTA: ${p.lta || '-'}% ‚Ä¢ LTC: ${p.ltc || '-'}%
</small>
</td>
<td style="font-weight:bold;">
${p.ltvNet}%<br>
<small style="color:var(--text-soft);">LTV brut: ${p.ltv}%</small>
</td>
<td>
<span class="badge ${badgeClass}">${p.status}</span><br>
<small style="color:var(--text-soft);">
Marge: ${p.marge}% ‚Ä¢ Score: ${p.scoreRisque}/100
</small>
</td>
<td>
<small style="color:var(--text-soft);">IA: ${p.investSuggest}‚Ç¨</small><br>
<b style="color:var(--blue)">R√âEL: ${p.investReal}‚Ç¨</b>
</td>
<td>
<button onclick="suppr(${db.length - 1 - idx})"
style="border:none; background:none; cursor:pointer; color:var(--text-soft);">
‚úñ
</button>
</td>
</tr>`;
    });

    if (db.length > 0) {
        const avgScore = Math.round(sScore / db.length);
        document.getElementById('avgRisk').innerText = avgScore + "/100";
        document.getElementById('totalInvest').innerText = sTotal + " ‚Ç¨";

        const label = document.getElementById('riskLabel');
        if (avgScore <= 30) { label.innerText = "S√âCURIS√â üõ°Ô∏è"; label.style.color = "var(--emerald)"; }
        else if (avgScore <= 50) { label.innerText = "√âQUILIBR√â ‚öñÔ∏è"; label.style.color = "var(--blue)"; }
        else if (avgScore <= 70) { label.innerText = "VIGILANCE ‚ö†Ô∏è"; label.style.color = "var(--amber)"; }
        else { label.innerText = "CRITIQUE üö®"; label.style.color = "var(--rose)"; }

    } else {
        document.getElementById('avgRisk').innerText = "0/100";
        document.getElementById('totalInvest').innerText = "0 ‚Ç¨";
        const label = document.getElementById('riskLabel');
        label.innerText = "Aucun projet";
        label.style.color = "var(--text-soft)";
    }
}

function suppr(idx) {
    let db = JSON.parse(localStorage.getItem('immo_v34')) || [];
    db.splice(idx, 1);
    localStorage.setItem('immo_v34', JSON.stringify(db));
    render();
}

function exportCSV() {
    const db = JSON.parse(localStorage.getItem('immo_v34')) || [];
    if (db.length === 0) return alert("Aucune donn√©e.");

    let csv = "Date;Nom;LTV;Marge;Precom;Liq;Surete;Couv;LTA;LTC;LTVNet;Score;Status;IA;Reel\n";

    db.forEach(p => {
        csv += `${p.date};${p.nom};${p.ltv};${p.marge};${p.precom};${p.liq};${p.type};${p.cov};${p.lta || ""};${p.ltc || ""};${p.ltvNet};${p.scoreRisque};${p.status};${p.investSuggest};${p.investReal}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.setAttribute("download", `Audit_Master_v34.csv`);
    link.click();
}

// ===========================
// TH√àME CLAIR / SOMBRE
// ===========================
function toggleTheme() {
    const isLight = document.body.classList.toggle("light");
    localStorage.setItem("theme", isLight ? "light" : "dark");
    const btn = document.getElementById("themeBtn");
    btn.textContent = isLight ? "Mode sombre" : "Mode clair";
}

document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById("themeBtn");

    if (localStorage.getItem("theme") === "light") {
        document.body.classList.add("light");
        btn.textContent = "Mode sombre";
    } else {
        btn.textContent = "Mode clair";
    }

    render();
});

// ===========================
// EXPOSITION DES FONCTIONS
// ===========================
window.ajouterProjet = ajouterProjet;
window.toggleHelp = toggleHelp;
window.toggleTheme = toggleTheme;
window.exportCSV = exportCSV;
window.suppr = suppr;

</script>

<!-- ===========================
SERVICE WORKER
=========================== -->
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
}
</script>

</body>
</html>






